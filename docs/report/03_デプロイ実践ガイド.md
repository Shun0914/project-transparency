# デプロイ実践ガイド - フルスタックアプリケーションの本番環境構築

## 概要

このガイドは、Next.js + FastAPIのフルスタックアプリケーションを、Vercel（フロントエンド）とRender（バックエンド）にデプロイする手順を詳しく解説します。

---

## 前提知識

### デプロイとは

**開発環境（ローカル）:**
```
あなたのPC
├── http://localhost:3000 (フロントエンド)
└── http://localhost:8000 (バックエンド)
```

**本番環境（デプロイ後）:**
```
インターネット
├── https://your-app.vercel.app (フロントエンド)
└── https://your-api.onrender.com (バックエンド)
```

**違いは:**
- URLが変わるだけ
- 世界中の誰でもアクセスできる
- 常時稼働している

---

### なぜフロントとバックを分けてデプロイするのか

**分ける必要はないが、分けた方が効率的**

#### Vercelの強み
- Next.jsを作った会社が提供
- CDN（世界中にキャッシュ）が自動
- ビルドが異常に速い
- 完全無料

#### Renderの強み
- Python/FastAPIをそのまま動かせる
- データベースも置ける
- APIに特化している

**結論: それぞれに最適化されたプラットフォームを使う方が効率的**

---

## 全体の流れ

```
1. GitHubにコードをpush
   ↓
2. バックエンドをRenderにデプロイ
   - PostgreSQL作成
   - FastAPI起動
   - URLを取得
   ↓
3. フロントエンドをVercelにデプロイ
   - 環境変数に↑のURLを設定
   - Next.jsビルド
   - URLを取得
   ↓
4. 動作確認
```

---

## 事前準備

### 必要なもの

- [ ] GitHubアカウント
- [ ] Renderアカウント（無料）
- [ ] Vercelアカウント（無料）
- [ ] コードがGitHubにpush済み

### GitHubへのpush

```bash
cd /path/to/your/project

# 初回のみ
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/[username]/[repo].git
git push -u origin main
```

---

## Part 1: バックエンドのデプロイ（Render）

### Step 1: アカウント作成

1. https://render.com/ にアクセス
2. 「Get Started for Free」をクリック
3. GitHubアカウントで連携

### Step 2: Web Service作成

1. ダッシュボードで「New」→「Web Service」
2. GitHubリポジトリを選択
3. 「Connect」をクリック

### Step 3: 設定

```
Name: project-transparency-api
Region: Oregon (US West)
Branch: main
Root Directory: backend
Runtime: Python 3
Build Command: pip install -r requirements.txt
Start Command: uvicorn app.main:app --host 0.0.0.0 --port $PORT
Instance Type: Free
```

**重要ポイント:**
- `Root Directory`を`backend`に設定
- `$PORT`はRenderが自動で設定する環境変数

### Step 4: デプロイ

「Create Web Service」をクリック

**デプロイ中:**
- ログがリアルタイムで表示される
- 5-10分かかる
- 緑色の「Live」になったら完了

### Step 5: URLを確認

```
https://project-transparency-api.onrender.com
```

**このURLをメモしておく！**（後でフロントエンドの設定で使う）

---

## Part 2: データベースの追加（Render）

### Step 1: PostgreSQL作成

1. ダッシュボードで「New」→「PostgreSQL」
2. 設定:
   ```
   Name: project-transparency-db
   Plan: Free
   Region: Oregon
   ```
3. 「Create Database」をクリック

### Step 2: 接続情報を確認

データベースのページで「Connect」タブ:
```
Internal Database URL:
postgresql://user:password@host/database
```

**このURLをコピー！**

### Step 3: バックエンドに環境変数を設定

1. Web Service（project-transparency-api）のページへ
2. 「Environment」タブ
3. 「Add Environment Variable」
4. 入力:
   ```
   Key: DATABASE_URL
   Value: postgresql://user:password@host/database
   ```
5. 「Save Changes」

**自動で再デプロイが始まります**

---

## Part 3: CORS設定の修正

### なぜ必要か

フロントエンド（Vercel）からバックエンド（Render）にアクセスするため、CORS（Cross-Origin Resource Sharing）設定が必要です。

### ローカルで修正

`backend/app/main.py`:

```python
# 既存のCORS設定を修正
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",  # ローカル開発用
    ],
    allow_origin_regex=r"https://.*\.vercel\.app",  # Vercel全サブドメイン許可
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### GitHubにpush

```bash
git add backend/app/main.py
git commit -m "Add CORS settings for production"
git push origin main
```

**Renderが自動で再デプロイします**

---

## Part 4: フロントエンドのデプロイ（Vercel）

### Step 1: アカウント作成

1. https://vercel.com/ にアクセス
2. 「Start Deploying」
3. GitHubアカウントで連携

### Step 2: プロジェクトをインポート

1. 「Add New...」→「Project」
2. GitHubリポジトリを選択
3. 「Import」をクリック

### Step 3: 設定

```
Framework Preset: Next.js
Root Directory: frontend
Build Command: npm run build
Output Directory: (空欄)
Install Command: npm install
```

### Step 4: 環境変数を設定

「Environment Variables」セクション:

```
Key: NEXT_PUBLIC_API_BASE_URL
Value: https://project-transparency-api.onrender.com/api
```

**重要:**
- Part 1 Step 5でメモしたRenderのURLを使う
- `/api`まで含める

### Step 5: デプロイ

「Deploy」をクリック

**デプロイ中:**
- ビルドログがリアルタイムで表示される
- 3-5分かかる
- 「Congratulations!」が出たら完了

### Step 6: URLを確認

```
https://project-transparency-xxx.vercel.app
```

---

## Part 5: 動作確認

### アクセス

Vercelで取得したURLにブラウザでアクセス:
```
https://project-transparency-xxx.vercel.app
```

### テスト項目

1. **プロジェクト作成**
   - 「+ 新規プロジェクト」をクリック
   - プロジェクト名とURLを入力
   - 作成できるか確認

2. **メンバー追加**
   - プロジェクトを開く
   - 「+ メンバー追加」をクリック
   - 名前、役職を入力
   - 追加できるか確認

3. **スコア入力**
   - 「スコア入力」をクリック
   - スライダーで0-100を設定
   - 登録できるか確認

4. **ダッシュボード表示**
   - 加重平均が表示されるか
   - グラフが表示されるか
   - メンバー別スコアが表示されるか

---

## トラブルシューティング

### エラー1: CORSエラー

**症状:**
```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```

**原因:**
- CORS設定が正しくない
- RenderのURLが間違っている

**解決方法:**
1. `backend/app/main.py`のCORS設定を確認
2. `allow_origin_regex`が正しいか確認
3. GitHubにpushして再デプロイ

---

### エラー2: APIに接続できない

**症状:**
```
Network Error
Failed to fetch
```

**原因:**
- 環境変数が正しくない
- RenderのサービスがLiveになっていない

**解決方法:**
1. Vercelの環境変数を確認
   - `NEXT_PUBLIC_API_BASE_URL`が正しいか
   - `/api`まで含まれているか
2. RenderのWeb Serviceが「Live」になっているか確認
3. Renderのログで起動エラーがないか確認

---

### エラー3: Renderのビルドが失敗

**症状:**
```
Build failed
Error: ...
```

**原因:**
- `requirements.txt`が正しくない
- Pythonバージョンの問題
- 依存関係のエラー

**解決方法:**
1. Renderのログを確認
2. エラーメッセージをよく読む
3. ローカルで`pip install -r requirements.txt`が成功するか確認
4. 必要に応じて`requirements.txt`を修正してpush

---

### エラー4: Vercelのビルドが失敗

**症状:**
```
Build failed
Error: ...
```

**原因:**
- `package.json`が正しくない
- Node.jsバージョンの問題
- 依存関係のエラー

**解決方法:**
1. Vercelのログを確認
2. ローカルで`npm install && npm run build`が成功するか確認
3. 必要に応じて`package.json`を修正してpush

---

### エラー5: Renderが遅い・タイムアウト

**症状:**
- 初回アクセスが30秒以上かかる
- たまにタイムアウトする

**原因:**
- 無料プランは15分間アクセスがないとスリープする
- 初回アクセス時に起動に時間がかかる

**解決方法:**
- 仕様です（無料プランの制限）
- 有料プランに変更すると解決
- または、定期的にアクセスしてスリープさせない

---

## CI/CD（継続的デプロイ）

### 仕組み

```
あなた: git push origin main
  ↓
GitHub: 変更を検知
  ↓
Render: 自動でビルド・デプロイ
Vercel: 自動でビルド・デプロイ
  ↓
本番環境に反映
```

### メリット

- コードを修正したら自動でデプロイ
- 手動でデプロイする必要なし
- 常に最新版が本番環境に

### デメリット

- 壊れたコードをpushすると本番が壊れる
- 事前にローカルでテストが重要

---

## 環境変数の管理

### フロントエンド（Vercel）

**設定場所:**
Vercel Dashboard → Project → Settings → Environment Variables

**必要な変数:**
```
NEXT_PUBLIC_API_BASE_URL=https://your-api.onrender.com/api
```

**注意:**
- `NEXT_PUBLIC_`プレフィックスが必要
- これがないとブラウザからアクセスできない

### バックエンド（Render）

**設定場所:**
Render Dashboard → Web Service → Environment

**必要な変数:**
```
DATABASE_URL=postgresql://user:password@host/database
```

**注意:**
- 環境変数を変更すると自動で再デプロイ
- 機密情報（パスワードなど）は環境変数で管理

---

## データベースの管理

### RenderのPostgreSQL

**接続方法:**

#### 方法1: Render Dashboard
1. PostgreSQLのページ
2. 「Connect」タブ
3. 「External Connection」のコマンドをコピー
4. ローカルで実行

```bash
psql postgresql://user:password@host/database
```

#### 方法2: GUI Tool
- pgAdmin
- DBeaver
- DataGrip

接続情報はRenderのダッシュボードで確認

### マイグレーション

**初回:**
```bash
# FastAPIが自動でテーブル作成
# main.pyで実行される:
Base.metadata.create_all(bind=engine)
```

**スキーマ変更時:**
- Alembic等のマイグレーションツールを使う
- または、手動でALTER TABLE

---

## デモデータの投入

### 方法1: Renderのシェルから

1. Render Dashboard → Web Service
2. 右上の「Shell」ボタン
3. Pythonスクリプトを実行

```bash
python insert_demo_data.py
```

### 方法2: ローカルから

```bash
# 環境変数を設定
export DATABASE_URL=postgresql://...

# スクリプト実行
python backend/insert_demo_data.py
```

### 方法3: Claude Code + Render MCP

```
プロンプト:
「Renderのデータベースにデモデータを投入して」
```

Claude Codeが自動で実行

---

## 料金

### Render（無料プラン）

**Web Service:**
- 750時間/月まで無料
- 複数サービスで共有
- 15分間アクセスがないとスリープ

**PostgreSQL:**
- 90日間無料
- 1GB storage
- 以降は削除される

### Vercel（Hobby プラン）

**完全無料:**
- 無制限のプロジェクト
- 100GB帯域/月
- CDN配信

**制限:**
- 商用利用は有料プラン必要

---

## セキュリティ

### API Keyの管理

**絶対にやってはいけないこと:**
- API KeyをGitHubにpush
- ハードコードする
- 公開する

**正しい管理方法:**
- 環境変数で管理
- `.env`ファイルを`.gitignore`に追加
- Render/Vercelのダッシュボードで設定

### HTTPS

- Render: 自動でHTTPS化
- Vercel: 自動でHTTPS化
- 証明書の更新も自動

### データベースアクセス

- RenderのPostgreSQLは外部からアクセス可
- 強いパスワードを使う
- 必要に応じてIP制限

---

## モニタリング

### Render

**Logs:**
- リアルタイムログ
- エラーログの確認
- アクセスログ

**Metrics:**
- CPU使用率
- メモリ使用率
- レスポンスタイム

### Vercel

**Analytics:**
- ページビュー
- リアルタイムユーザー数
- パフォーマンス指標

**Logs:**
- ビルドログ
- デプロイログ
- ランタイムログ

---

## スケーリング

### 有料プランへのアップグレード

**Render:**
```
Starter: $7/月
- スリープなし
- より高性能
```

**Vercel:**
```
Pro: $20/月
- 商用利用可
- より多くの帯域
```

### 水平スケーリング

**Render:**
- インスタンス数を増やす
- ロードバランサーが自動で分散

**Vercel:**
- 自動でスケール
- CDNが世界中に配信

---

## まとめ

### デプロイの流れ（再掲）

```
1. GitHubにpush
   ↓
2. Render（バックエンド）
   - PostgreSQL作成
   - 環境変数設定
   - FastAPIデプロイ
   ↓
3. Vercel（フロントエンド）
   - 環境変数設定（RenderのURL）
   - Next.jsデプロイ
   ↓
4. 動作確認
```

### チェックリスト

デプロイ前:
- [ ] GitHubにコードがpush済み
- [ ] `.gitignore`が設定済み
- [ ] ローカルで動作確認済み

バックエンド（Render）:
- [ ] Web Service作成
- [ ] PostgreSQL作成
- [ ] 環境変数設定（DATABASE_URL）
- [ ] CORS設定修正
- [ ] デプロイ成功

フロントエンド（Vercel）:
- [ ] Project作成
- [ ] 環境変数設定（NEXT_PUBLIC_API_BASE_URL）
- [ ] デプロイ成功

動作確認:
- [ ] プロジェクト作成できる
- [ ] メンバー追加できる
- [ ] スコア入力できる
- [ ] ダッシュボード表示される

---

## 参考資料

### 公式ドキュメント

**Render:**
- https://render.com/docs
- https://render.com/docs/deploy-fastapi

**Vercel:**
- https://vercel.com/docs
- https://nextjs.org/docs/deployment

**FastAPI:**
- https://fastapi.tiangolo.com/deployment/

**Next.js:**
- https://nextjs.org/docs

---

## よくある質問

### Q1: デプロイにどのくらい時間がかかる？

**A:** 
- Render: 5-10分（初回）、3-5分（2回目以降）
- Vercel: 3-5分

### Q2: 無料で使い続けられる？

**A:** 
- 個人プロジェクトなら無料で十分
- 商用利用は有料プラン推奨
- RenderのPostgreSQLは90日制限あり

### Q3: 独自ドメインは使える？

**A:** 
- 使えます
- Vercel: 設定が簡単
- Render: カスタムドメイン設定

### Q4: デプロイを取り消せる？

**A:** 
- Vercel: 以前のバージョンにロールバック可能
- Render: 手動で以前のコミットにロールバック

### Q5: ログはどこで見る？

**A:** 
- Render: ダッシュボードの「Logs」タブ
- Vercel: ダッシュボードの「Logs」セクション

---

## 終わりに

このガイドに従えば、フルスタックアプリケーションを本番環境にデプロイできます。

**重要なポイント:**
1. 環境変数の管理
2. CORS設定
3. CI/CDの理解
4. トラブルシューティング

**次のステップ:**
- カスタムドメインの設定
- 有料プランへのアップグレード
- モニタリングの強化
- セキュリティの改善

頑張ってください！🚀
